# 账号过期提示功能 - 修改说明（含代码上下文）

> 说明：本文件只展示“本次新增/修改/删除”相关的代码片段，并给出必要上下文；所有代码均非 diff 格式。每处修改都给出简短修改意图，并在代码中用“特殊注释”标记新增/修改部位与作用。

---

## 1) 后端：过期标记与清除

**修改意图：**当账号通过页面校验时清除过期标记；当判定为登录态失效时，标记为过期并记录原因，供 UI 提示。

**文件（绝对路径）：**
- `E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\src\core\BrowserManager.js`

### 1.1 账号初始化流程
```js
async launchOrSwitchContext(authIndex) {
    // ...省略无关上下文

    // [修改] 校验通过即清除过期标记；若失败且为登录失效则标记过期
    await this._checkPageStatusAndErrors("[Browser]");
    this.authSource.clearAuthExpired(authIndex);

    // ...省略无关上下文
} catch (error) {
    if (this._isAuthExpiredError(error)) {
        this.authSource.markAuthExpired(authIndex, error.message || "");
    }
    await this._saveDebugArtifacts("init_failed");
    await this.closeBrowser();
    this._currentAuthIndex = -1;
    throw error;
}
```

### 1.2 轻量重连流程
```js
async attemptLightweightReconnect() {
    // ...省略无关上下文

    // [修改] 轻量重连校验通过后清除过期标记；失败且判定过期则写入原因
    await this._checkPageStatusAndErrors("[Reconnect]");
    this.authSource.clearAuthExpired(authIndex);

    // ...省略无关上下文
} catch (error) {
    if (this._isAuthExpiredError(error)) {
        this.authSource.markAuthExpired(authIndex, error.message || "");
    }
    await this._saveDebugArtifacts("reconnect_failed");
    return false;
}
```

> 逻辑推断说明：已有 `_isAuthExpiredError()` 用于判断登录失效信息，本次直接复用，避免额外字符串匹配与重复分配，降低 GC 压力。

---

## 2) 后端：状态接口返回过期字段

**修改意图：**在 `/api/status` 返回每个账号的过期信息，前端无需新增接口即可提示。

**文件（绝对路径）：**
- `E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\src\routes\StatusRoutes.js`

```js
const accountDetails = initialIndices.map(index => {
    const isInvalid = invalidIndices.includes(index);
    const name = isInvalid ? null : accountNameMap.get(index) || null;

    const canonicalIndex = isInvalid ? null : authSource.getCanonicalIndex(index);
    const isDuplicate = canonicalIndex !== null && canonicalIndex !== index;
    const isRotation = rotationIndices.includes(index);

    // [新增] 透出过期标记与原因，供 UI 显示
    const expiredInfo = isInvalid ? null : authSource.getExpiredInfo(index);
    const isExpired = !!expiredInfo;
    const expiredReason = expiredInfo ? expiredInfo.reason || "" : null;
    const expiredTime = expiredInfo ? expiredInfo.time || null : null;

    return {
        canonicalIndex,
        expiredReason,
        expiredTime,
        index,
        isDuplicate,
        isExpired,
        isInvalid,
        isRotation,
        name,
    };
});
```

---

## 3) 前端：账号列表/当前账号过期提示

**修改意图：**在账号列表与当前账号区域直观显示“过期”状态，并在 tooltip 中展示原因。

**文件（绝对路径）：**
- `E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\ui\app\pages\StatusPage.vue`

### 3.1 账号列表与当前账号 UI
```vue
<span class="value account-value">
    <span class="account-name" :class="currentAccountNameClass">
        #{{ state.currentAuthIndex }} {{ currentAccountName }}
    </span>
    <el-tooltip
        v-if="currentAccountExpired"
        :content="getAccountExpiredHint(currentAccountInfo)"
        placement="top"
        effect="dark"
        :hide-after="0"
    >
        <span class="expired-badge">{{ t("tagExpired") }}</span>
    </el-tooltip>
</span>

<!-- ...省略无关上下文 -->

<div
    v-for="item in state.accountDetails"
    :key="item.index"
    class="account-list-item"
    :class="{
        'is-current': item.index === state.currentAuthIndex,
        'is-expired': item.isExpired,
    }"
>
    <el-tooltip :content="getAccountDisplayName(item)" placement="top" effect="dark" :hide-after="0">
        <div class="account-info" style="cursor: pointer">
            <span class="account-index">#{{ item.index }}</span>
            <span
                class="account-email"
                :class="{ 'is-error': item.isInvalid, 'is-duplicate': item.isDuplicate, 'is-expired': item.isExpired }"
            >
                {{ getAccountDisplayName(item) }}
            </span>
            <span v-if="item.index === state.currentAuthIndex" class="current-badge">
                {{ t("tagCurrent") }}
            </span>
            <el-tooltip
                v-if="item.isExpired"
                :content="getAccountExpiredHint(item)"
                placement="top"
                effect="dark"
                :hide-after="0"
            >
                <span class="expired-badge">{{ t("tagExpired") }}</span>
            </el-tooltip>
        </div>
    </el-tooltip>
</div>
```

### 3.2 过期状态计算与提示文本
```js
const currentAccountInfo = computed(() => {
    // [新增] 统一取当前账号对象，减少重复查找与临时对象创建
    if (state.currentAuthIndex < 0) {
        return null;
    }
    return state.accountDetails.find(acc => acc.index === state.currentAuthIndex) || null;
});

const currentAccountName = computed(() => {
    if (state.currentAuthIndex < 0) {
        return t("noActiveAccount");
    }
    return currentAccountInfo.value ? getAccountDisplayName(currentAccountInfo.value) : t("noActiveAccount");
});

const currentAccountNameClass = computed(() => {
    // [修改] 当前账号过期时，强调错误样式
    if (state.currentAuthIndex < 0) {
        return "status-error";
    }
    if (!currentAccountInfo.value) {
        return "status-error";
    }
    if (currentAccountInfo.value.isExpired) {
        return "status-error";
    }
    return "";
});

const currentAccountExpired = computed(() => !!(currentAccountInfo.value && currentAccountInfo.value.isExpired));

const getAccountExpiredHint = account => {
    // [新增] 优先展示后端过期原因，空则给统一提示
    if (!account || !account.isExpired) {
        return "";
    }
    const reason = account.expiredReason || "";
    if (reason) {
        return t("accountExpiredHintWithReason", { reason });
    }
    return t("accountExpiredHint");
};
```

### 3.3 过期样式
```less
.account-list-item {
    // ...省略无关上下文

    &.is-expired {
        /* [新增] 过期账号高亮边框与底色 */
        border-color: rgba(var(--color-error-rgb), 0.6);
        background: rgba(var(--color-error-rgb), 0.06);
    }
}

.account-email {
    // ...省略无关上下文

    &.is-expired {
        /* [新增] 过期账号文字加重 */
        color: @error-color;
        font-weight: 600;
    }
}

.expired-badge {
    /* [新增] 过期标签样式 */
    font-size: 0.72rem;
    padding: 2px 8px;
    background: rgba(var(--color-error-rgb), 0.12);
    color: @error-color;
    border-radius: 12px;
    border: 1px solid rgba(var(--color-error-rgb), 0.35);
    flex-shrink: 0;
}
```

---

## 4) 文案（多语言）

**修改意图：**为“过期”标签与提示文本提供中英文支持。

**文件（绝对路径）：**
- `E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\ui\locales\zh.json`
- `E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\ui\locales\en.json`

```json
// [新增] 过期提示文案
"tagExpired": "过期",
"accountExpiredHint": "该账号可能已过期，请重新添加/登录。",
"accountExpiredHintWithReason": "该账号可能已过期：{reason}"
```

```json
// [新增] Expired hints
"tagExpired": "Expired",
"accountExpiredHint": "This account appears to be expired. Please re-add the account.",
"accountExpiredHintWithReason": "This account appears to be expired: {reason}"
```

---

## 产品级可选重构方案（建议）

1) **过期状态统一管理（状态机化）**
   - 目标：将“未验证 / 可用 / 过期 / 重试中 / 受限”等状态统一抽象为枚举，并在 UI 显示层统一处理标签样式。
   - 优点：减少散落的 if 判断与重复字段，降低后续扩展成本。

2) **降低状态轮询负担**
   - 目标：对 `/api/status` 增量字段做 ETag/版本号缓存，前端变更时再刷新，减少 JSON 分配与 GC 压力。
   - 优点：前端与后端均可降低不必要的对象创建。

3) **过期原因归类与国际化**
   - 目标：将“cookie expired / redirected to login”归类为结构化 code，再由 i18n 映射展示原因。
   - 优点：减少日志原文直接上屏导致的可读性问题。

---

## 总结 ✅

- 已在后端识别并标记账号过期状态，并在状态接口中返回过期原因与时间。
- 前端新增“过期”标签与提示，并在当前账号与列表中高亮显示。
- 文案已补齐中英文，满足 UI 展示与国际化需求。

✨ 如需“过期时间”直观展示或自动弹窗提醒，我可以继续扩展。