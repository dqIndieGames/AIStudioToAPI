# 小托盘功能 - 修改说明（含代码上下文）

> 说明：本文件只展示本次新增/修改相关代码（非 diff 格式），每处修改给出简短“修改意图”。新增/修改位置以 `[变更]` 注释标记。每个函数内最多一行注释。注意 GC：实现使用系统托盘与轻量计时器，避免多余分配。

---

## 1) 启动后拉起托盘进程

**修改意图：**服务启动成功后自动拉起 Windows 小托盘（右键：重启/关闭）。

**文件（绝对路径）：**  
`E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\main.js`

```js
const ProxyServerSystem = require("./src/core/ProxyServerSystem");
const TrayLauncher = require("./src/utils/TrayLauncher"); // [变更] 新增托盘启动器引用

const initializeServer = async () => {
    const initialAuthIndex = parseInt(process.env.INITIAL_AUTH_INDEX, 10) || null;

    try {
        const serverSystem = new ProxyServerSystem();
        await serverSystem.start(initialAuthIndex);
        TrayLauncher.start(serverSystem.logger, { projectDir: __dirname, title: "AIStudioToAPI" }); // [变更] 启动托盘
    } catch (error) {
        console.error("Server startup failed:", error.message);
        process.exit(1);
    }
};
```

---

## 2) 新增 Tray 启动器（Node 侧）

**修改意图：**在 Windows 下以后台方式启动 PowerShell 托盘脚本，避免 UI 依赖和额外窗口。

**文件（绝对路径）：**  
`E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\src\utils\TrayLauncher.js`

```js
class TrayLauncher {
    static start(logger, options = {}) {
        // [变更] Windows 下启动托盘进程，并传入重启/退出所需参数
        if (process.platform !== "win32") {
            return null;
        }

        if (String(process.env.DISABLE_TRAY || "").toLowerCase() === "true") {
            if (logger?.info) {
                logger.info("[Tray] Disabled by DISABLE_TRAY=true.");
            }
            return null;
        }

        const projectDir = options.projectDir || process.cwd();
        const trayScript = path.join(__dirname, "..", "..", "scripts", "tray", "tray.ps1");
        if (!fs.existsSync(trayScript)) {
            if (logger?.warn) {
                logger.warn(`[Tray] Tray script not found: ${trayScript}.`);
            }
            return null;
        }

        const startCmd = path.join(projectDir, "start_project.cmd");
        const args = [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-File",
            trayScript,
            "-ServerPid",
            String(process.pid),
            "-ProjectDir",
            projectDir,
            "-StartCmd",
            startCmd,
            "-Title",
            options.title || "AIStudioToAPI",
        ];

        const child = spawn("powershell.exe", args, {
            detached: true,
            stdio: "ignore",
            windowsHide: true,
        });
        child.unref();
        if (logger?.info) {
            logger.info("[Tray] Windows tray launched.");
        }
        return child;
    }
}

module.exports = TrayLauncher;
```

---

## 3) 新增托盘脚本（PowerShell）

**修改意图：**在系统托盘提供“重启/关闭”入口，并在服务退出时自动清理托盘图标。

**文件（绝对路径）：**  
`E:\vscodeProject\AI_Helper_Suite\auto_operate_aistudio_claude\AIStudioToAPI\scripts\tray\tray.ps1`

```powershell
$restartItem.Text = "重启" # [变更] 右键菜单文案
$exitItem.Text = "关闭" # [变更] 右键菜单文案
```

```powershell
$restartItem.add_Click({
    # [变更] 点击重启：先拉起新实例，再结束旧进程
    if ($StartCmd -and (Test-Path -LiteralPath $StartCmd)) {
        Start-Process -FilePath $StartCmd -WorkingDirectory $ProjectDir | Out-Null
    } elseif ($ProjectDir) {
        $cmd = "cd /d `"$ProjectDir`" && npm run start"
        Start-Process -FilePath "cmd.exe" -ArgumentList "/c", "start `"$Title`" cmd /k `"$cmd`"" | Out-Null
    }

    if ($ServerPid -gt 0) {
        try { Stop-Process -Id $ServerPid -Force | Out-Null } catch {}
    }
    $notifyIcon.Visible = $false
    [System.Windows.Forms.Application]::Exit()
})
```

```powershell
$exitItem.add_Click({
    # [变更] 点击关闭：结束旧进程并清理托盘
    if ($ServerPid -gt 0) {
        try { Stop-Process -Id $ServerPid -Force | Out-Null } catch {}
    }
    $notifyIcon.Visible = $false
    [System.Windows.Forms.Application]::Exit()
})
```

---

## GC 与性能说明

- 托盘脚本使用系统托盘图标（SystemIcons），不做磁盘图片解码，减少额外分配。  
- 心跳监测使用 1 秒 Timer，无线程池反复创建，避免 GC 波动。

---

## 产品级重构建议（可选）

1) **温和重启/关闭接口**  
   提供 `/api/system/restart` 与 `/api/system/exit`，避免强杀进程造成资源未释放。

2) **单实例互斥锁**  
   托盘侧或主进程使用 Mutex，防止重复启动导致多个托盘图标和端口占用。

3) **托盘菜单扩展**  
   增加“打开控制台”“打开 Web UI”菜单，提高运维效率。

---

## 总结 ✅✨  

- 已实现 Windows 小托盘（右键：重启/关闭）并在服务启动后自动拉起。  
- 逻辑轻量、无 Tk 依赖、GC 压力低。  
- 可继续扩展为“温和重启/关闭 + 单实例锁”。